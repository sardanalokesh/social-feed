/*
 ep-ui 2016-07-18 
*/
var app=angular.module("EdgeForPublishers",["ui.router","angular-storage"]);app.config(function(a,b,c){a.state("login",{url:"/login",templateUrl:"templates/login.html",controller:"LoginCtrl"}).state("feeds",{url:"/feeds","abstract":!0,templateUrl:"templates/feeds.html"}).state("feeds.home",{url:"/home",templateUrl:"templates/feeds-home.html",controller:"FeedsHomeCtrl"}).state("feeds.profile",{url:"/profile",templateUrl:"templates/feeds-profile.html",controller:"FeedsProfileCtrl"}),b.otherwise("/login"),c.interceptors.push("authInterceptor")}),app.value("constants",{FEEDS_URL:"/user/feed?",SUBMIT_POST_URL:"/create/post",USER_INFO_URL:"/user/info?",SUBSCRIBE_URL:"/user/subscribe?",UNSUBSCRIBE_URL:"/user/unsubscribe?",TOPICS_LIST:"/topics/list",LIKE_URL:"/post/like?",UNLIKE_URL:"/post/unlike?",FILE_UPLOAD_URL:"/fileupload",FILE_URL_PREFIX:"/file/get?",LOGIN_PATH:"/loginSubmission",LOGOUT_PATH:"/logout"}),app.controller("FeedsHomeCtrl",function(a,b,c,d,e,f,g){function h(){b(function(){i()},4e3)}function i(){var b=d.FEEDS_URL+"userName="+q.username;c.ajaxGet(b,!0).then(function(b){b.map(function(a){a.timeStamp=new moment(a.timeStamp).fromNow()}),a.feedCards=b})}function j(b){return a.currentUserDetails&&b.likingUsers.indexOf(a.currentUserDetails.name)>-1}function k(b){b.likes++,b.likingUsers.unshift(a.currentUserDetails.name);var e=d.LIKE_URL+"postId="+b.id+"&userName="+a.currentUserDetails.userName;c.ajaxGet(e,!0).then(function(a){b.likingUsers=a})}function l(b){b.likes--;var e=b.likingUsers.indexOf(a.currentUserDetails.name);e>-1&&b.likingUsers.splice(e,1);var f=d.UNLIKE_URL+"postId="+b.id+"&userName="+a.currentUserDetails.userName;c.ajaxGet(f,!0).then(function(a){b.likingUsers=a})}function m(){a.newPost={topic:"Exponential"}}function n(a){var b=angular.copy(a);return b.likingUsers.toString()}function o(){var b=a.attachmentImage,c=d.FILE_UPLOAD_URL;g.upload(b,c,function(b){a.newPost.attachmentId=b,angular.element("#imageUploadModal").modal("hide")})}function p(a){return d.FILE_URL_PREFIX+"id="+a}var q=e.getCurrentUser();e.getUserDetails(function(b){a.currentUserDetails=b}),f.getAllTopics(function(b){a.allTopics=b,h()}),m(),i(),a.submitPost=function(b){m(),b.author=a.currentUserDetails.name,b.content&&b.author&&(b.likingUsers=[],a.feedCards.unshift(b),c.ajaxPost(d.SUBMIT_POST_URL,b,!0).then(function(b){a.feedCards[0].id=b}))},a.toggleLike=function(a){j(a)?l(a):k(a)},a.alreadyLiked=j,a.getLikingUsers=n,a.uploadFile=o,a.getImageUrl=p}),app.controller("FeedsProfileCtrl",function(a,b,c,d,e){function f(b){return a.userTopics.indexOf(b)>-1}function g(a){var b=e.UNSUBSCRIBE_URL+"userName="+l.username+"&topic="+a;d.ajaxGet(b,!0).then(function(a){console.log("topic successfully unsubscribed - "+a)})}function h(a){var b=e.SUBSCRIBE_URL+"userName="+l.username+"&topic="+a;d.ajaxGet(b,!0).then(function(a){console.log("topic successfully subscribed - "+a)})}function i(b){var c=a.userTopics.indexOf(b);c>-1&&a.userTopics.splice(c,1)}function j(b){a.userTopics.push(b)}function k(){var b=11;return a.currentUserDetails&&a.currentUserDetails.avatarId&&(b=a.currentUserDetails.avatarId),e.FILE_URL_PREFIX+"id="+b}var l=b.getCurrentUser();b.getUserDetails(function(b){a.currentUserDetails=b,a.userTopics=a.currentUserDetails.subscribedTopics}),c.getAllTopics(function(b){a.allTopics=b}),a.unfollowTopic=function(b){var c=a.userTopics.indexOf(b);c>-1&&(a.userTopics.splice(c,1),g(b))},a.toggleTopicFollow=function(a){f(a)?(i(a),g(a)):(j(a),h(a))},a.getFollowButtonText=function(a){return f(a)?"Unfollow":"Follow"},a.getDisplayImageUrl=k}),app.controller("LoginCtrl",function(a,b,c,d,e,f,g,h){a.fieldNames={userEmail:"Email",userPassword:"Password"},a.constants={MIN_PASS_LENGTH:8},a.showLoginError=!0,a.hasError=function(b){var c=a.loginForm[b];return c.$touched&&c.$invalid},a.isValid=function(b){var c=a.loginForm[b];return c.$touched&&c.$valid},a.showHelpText=function(b){var c=a.loginForm[b];return(a.loginForm.$submitted||c.$touched)&&c.$invalid},a.getHelpText=function(b){var c="";if("login"==b)c=a.loginError;else{var d=a.loginForm[b];d.$invalid&&(d.$error.required?c=a.fieldNames[b]+" is required.":d.$error.email?c="Please enter a valid email.":d.$error.minlength&&(c=a.fieldNames[b]+" should have atleast "+a.constants.MIN_PASS_LENGTH+" characters."))}return c},a.submit=function(){a.showLoginError=!1,a.loginError="",f.login(a.user).then(function(b){a.user.access_token=b.access_token,g.setCurrentUser(a.user),h.publish("authorized"),c.go("feeds.home")},function(b){console.error(b.error),a.showLoginError=!0,a.loginError=b.error})};var i=g.getCurrentUser();i&&c.go("feeds.home")}),app.directive("fileModel",["$parse",function(a){return{restrict:"A",link:function(b,c,d){var e=a(d.fileModel),f=e.assign;c.bind("change",function(){b.$apply(function(){f(b,c[0].files[0])})})}}}]),app.directive("loader",function(a){return{restrict:"E",templateUrl:"templates/loader.html",scope:{},controller:function(b){b.showLoader=!1,a.subscribe("loader.show",function(){b.showLoader=!0}),a.subscribe("loader.hide",function(){b.showLoader=!1})}}}),app.directive("navBar",function(a,b,c,d){return{restrict:"E",templateUrl:"templates/navbar.html",scope:{user:"="},controller:function(e){b.subscribe("authorized",function(){e.currentUser=c.getCurrentUser()}),b.subscribe("unauthorized",function(){e.currentUser=c.setCurrentUser(null)}),e.logout=function(){d.logout(e.currentUser).then(function(b){e.currentUser=c.setCurrentUser(null),a.go("login")},function(a){console.log(a)})},e.currentUser=c.getCurrentUser(),e.$watch("currentUser",function(){e.currentUser||a.go("login")}),c.getUserDetails(function(a){e.currentUserDetails=a}),e.notifications=[{text:"Prashant and Avinash liked your post.",read:!1},{text:"A new post in Engineering by Vipul.",read:!1},{text:"A new post in Finance by Dilip.",read:!0}],e.totalUnreadNotifications=2}}}),app.directive("tooltip",function(){return{restrict:"A",link:function(a,b,c){$(b).hover(function(){$(b).tooltip("show")},function(){$(b).tooltip("hide")})}}}),app.service("authInterceptor",function(a,b,c,d,e){this.request=function(b){var c=e.get("user"),f=c?c.access_token:null;f&&(b.headers.authorization=f);var g=a.defer();return b.timeout=g.promise,f||b.url!=d.QUERY_ENGINE_URL||g.resolve(),b},this.responseError=function(a){return 401===a.status&&c.publish("unauthorized"),a}}),app.service("eventService",function(a){this.publish=function(b,c){a.$emit(b,c)},this.subscribe=function(b,c){a.$on(b,c)}}),app.service("fileUploader",function(a,b){this.upload=function(b,c,d){var e=new FormData;e.append("file",b),a.post(c,e,{transformRequest:angular.identity,headers:{"Content-Type":void 0}}).success(function(a){d(a)}).error(function(){})}}),app.service("loginService",function(a,b){var c=this;c.login=function(c){return a.ajaxPost(b.LOGIN_PATH,c)},c.logout=function(c){return a.ajaxPost(b.LOGOUT_PATH,c)},c.register=function(){}}),app.service("topicService",function(a,b){var c=null;this.getAllTopics=function(d){c?d(c):a.ajaxGet(b.TOPICS_LIST).then(function(a){c=a,d(c)})}}),app.service("userService",function(a,b,c){var d=null,e=null;this.setCurrentUser=function(b){return d=b,d&&delete d.password,a.set("user",b),d},this.getCurrentUser=function(){return d||(d=a.get("user")),d},this.getUserDetails=function(a){if(e)a(e);else{var f=b.USER_INFO_URL+"userName="+d.username;c.ajaxGet(f).then(function(b){e=b,a(e)})}}}),app.factory("util",function(a,b,c){return{ajaxPost:function(d,e,f){f||a.publish("loader.show");var g=c.defer();return b({method:"POST",url:d,data:e,headers:{"Content-Type":"application/json; charset=utf-8"}}).then(function(b){f||a.publish("loader.hide"),200==b.status?g.resolve(b.data):g.reject(b.data)},function(b){f||a.publish("loader.hide"),g.reject(b.data)}),g.promise},ajaxGet:function(d,e){e||a.publish("loader.show");var f=c.defer();return b({method:"GET",url:d,headers:{"Content-Type":"application/json; charset=utf-8"}}).then(function(b){e||a.publish("loader.hide"),200==b.status?f.resolve(b.data):f.reject(b.data)},function(b){e||a.publish("loader.hide"),f.reject(b.data)}),f.promise},getIterator:function(a,b){var c=0,d=b,e=1;return{get:function(){return a.slice(c,d)},next:function(){return c<a.length&&(c+=b,d=c+b,e++,c)},previous:function(){return d>0&&(d-=b,c=d-b,e--,c)},hasNext:function(){return d<a.length},hasPrevious:function(){return c>0},getTotalPages:function(){return Math.ceil(a.length/b)},getCurrentPage:function(){return e}}}}});